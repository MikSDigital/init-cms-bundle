{#

This file is part of the Sonata package.

(c) Thomas Rabaix <thomas.rabaix@sonata-project.org>

For the full copyright and license information, please view the LICENSE
file that was distributed with this source code.

#}

{% extends 'NetworkingInitCmsBundle::empty_layout.html.twig' %}

{% set ckParameters = {'CKEditor': app.request.get('CKEditor'), 'CKEditorFuncNum': app.request.get('CKEditorFuncNum')} %}
{% set active_tab = app.request.get('context') %}
{% block javascripts %}
    {{ parent() }}

    <script>
        $(function () {
            $(".select").click(function (e) {
                e.preventDefault();
                window.opener.CKEDITOR.tools.callFunction({{ app.request.get('CKEditorFuncNum')|escape('js') }}, $(this).attr("href"));
                window.close();
            });
        });
    </script>
{% endblock %}


{% block preview %}{% endblock %}
{% block page_title %}
    <h1>{{ 'title.select_media'|trans({}, 'MediaAdmin')|replace({'%span%': '<span class="info-soft">', '%span/%': "</span>"})|raw }}</h1>{% endblock %}
{% block container_class %}mini-container container{% endblock %}
{% block list_table %}
<div class="tab-content">
{% for name, context in media_pool.contexts %}
    {% if attribute(datagrid, name) is defined %}
        <div class="tab-pane {% if (active_tab is null and loop.first) or active_tab == name %}active{% endif %}"
             id="media_{{ name }}">
            <div class="{% if not app.request.isxmlhttprequest %}row{% endif %}">
                <div class="{% if not app.request.isxmlhttprequest %}span10{% endif %}">

                    {# provider #}
                    {% if persistent_paramerters.provider is not defined %}
                        {% set providers = media_pool.getProviderNamesByContext(name) %}
                        <ul class="nav nav-pills">
                            {% if providers|length > 1 %}
                                <li>
                                    <a><strong>{{ "label.select_provider"|trans({}, 'MediaAdmin') }}</strong></a>
                                </li>

                                {% if not persistent_parameters.provider %}
                                    <li class="active"><a
                                                href="{{ admin.generateUrl('init_ckeditor_browser', {'context': persistent_parameters.context, 'provider': null, 'active_tab' : name}|merge(ckParameters)) }}">{{ "link.all_providers"|trans({}, 'MediaAdmin') }}</a>
                                    </li>
                                {% else %}
                                    <li>
                                        <a href="{{ admin.generateUrl('init_ckeditor_browser', {'context': persistent_parameters.context, 'provider': null, 'active_tab' : name}|merge(ckParameters)) }}">{{ "link.all_providers"|trans({}, 'MediaAdmin') }}</a>
                                    </li>
                                {% endif %}

                                {% for provider_name in providers %}
                                    {% if persistent_parameters.provider == provider_name %}
                                        <li class="active"><a
                                                    href="{{ admin.generateUrl('init_ckeditor_browser', {'context': persistent_parameters.context, 'provider': provider_name, 'active_tab' : name}|merge(ckParameters)) }}">{{ provider_name|trans({}) }}</a>
                                        </li>
                                    {% else %}
                                        <li>
                                            <a href="{{ admin.generateUrl('init_ckeditor_browser', {'context': persistent_parameters.context, 'provider': provider_name, 'active_tab' : name}|merge(ckParameters)) }}">{{ provider_name|trans({}) }}</a>
                                        </li>
                                    {% endif %}
                                {% endfor %}
                            {% endif %}
                        </ul>
                    {% endif %}
                    
                    {% set filterParameters = admin.filterParameters|merge({'context': name}) %}
                    {% if attribute(datagrid, name).results|length > 0 %}
                        <table class="table table-hover table-compact">
                            {% block table_header %}
                                <thead>
                                <tr class="sonata-ba-list-field-header">
                                    {% for field_description in admin.list.elements %}
                                        {% if field_description.getOption('code') == '_batch' or field_description.name == '_action' %}
                                            {# Disable batch and actions #}
                                        {% else %}
                                            {% set sortable = false %}
                                            {% if field_description.options.sortable is defined and field_description.options.sortable %}
                                                {% set sortable             = true %}
                                                {% set current              =  attribute(datagrid, name).values._sort_by == field_description %}
                                                {% set sort_parameters      = admin.modelmanager.sortparameters(field_description,  attribute(datagrid, name))|merge(ckParameters) %}
                                                {% set sort_active_class    = current ? 'sonata-ba-list-field-order-active' : '' %}
                                                {% set sort_by              = current ?  attribute(datagrid, name).values._sort_order : field_description.options._sort_order %}
                                            {% endif %}

                                            {% spaceless %}
                                                <th class="sonata-ba-list-field-header-{{ field_description.type }} {% if sortable %} sonata-ba-list-field-header-order-{{ sort_by|lower }} {{ sort_active_class }}{% endif %}">
                                                    {% if sortable %}<a
                                                            href="{{ admin.generateUrl('init_ckeditor_browser', sort_parameters) }}">{% endif %}
                                                        {{ admin.trans(field_description.label) }}
                                                        {% if sortable %}</a>{% endif %}
                                                </th>
                                            {% endspaceless %}
                                        {% endif %}
                                    {% endfor %}
                                </tr>
                                </thead>
                            {% endblock %}

                            {% block table_body %}
                                <tbody>
                                {% for object in  attribute(datagrid, name).results %}
                                    <tr>
                                        <td colspan="{{ (admin.list.elements|length) - 1 }}">
                                            <div>
                                                {% if object.width %}
                                                    <a href="{% path object, 'reference' %}" class="select"
                                                       style="float: left; margin-right: 6px;">
                                                        {% thumbnail object, 'admin' with {'width': 75, 'height': 60} %}</a>
                                                {% endif %}
                                                <strong><a href="{{ path('networking_init_cms_file_download', {'id': object.id, 'name': object.getMetadataValue('filename')}) }}"
                                                           class="select">{{ object.name }}</a></strong> <br/>
                                                {{ object.providerName|trans({}, 'SonataMediaBundle') }}{% if object.width %}: {{ object.width }}{% if object.height %}x{{ object.height }}{% endif %}px{% endif %}
                                                <br/>
                                                {% if formats[name][object.id]|length > 0 %}
                                                    {% if object.width %}
                                                        - {{ 'title.formats'|trans({}, 'SonataMediaBundle') }}:
                                                        {% for name, format in formats[name][object.id] %}
                                                            <a href="{% path object, name %}"
                                                               class="select">{{ name }}</a> {% if format.width %}({{ format.width }}{% if format.height %}x{{ format.height }}{% endif %}px){% endif %}
                                                        {% endfor %}
                                                    {% endif %}
                                                {% endif %}
                                                <br/>
                                            </div>
                                        </td>
                                    </tr>
                                {% endfor %}
                                </tbody>
                            {% endblock %}

                            {% block table_footer %}

                                <tr>
                                    <th>
                                        <div class="form-inline">
                                            <div class="pull-right">
                                                {% transchoice  attribute(datagrid, name).pager.nbresults with {'%count%':  attribute(datagrid, name).pager.nbresults} from 'SonataAdminBundle' %}
                                                list_results_count{% endtranschoice %}
                                                {% block max_per_page %}
                                                    <label class="control-label"
                                                           for="{{ admin.uniqid }}_per_page">{% trans from 'SonataAdminBundle' %}
                                                        label_per_page{% endtrans %}</label>
                                                    <select class="per-page small" id="{{ admin.uniqid }}_per_page"
                                                            style="width: auto; height: auto">
                                                        {% for per_page in admin.getperpageoptions %}
                                                            <option {% if per_page == attribute(datagrid, name).pager.maxperpage %}selected="selected"{% endif %}
                                                                    value="{{ admin.generateUrl('init_ckeditor_browser', {'filter': attribute(datagrid, name).values|merge({'_per_page': per_page})}|merge(ckParameters)) }}">
                                                                {{ per_page }}
                                                            </option>
                                                        {% endfor %}
                                                    </select>
                                                {% endblock %}
                                            </div>
                                        </div>
                                    </th>
                                </tr>
                            {% endblock %}
                        </table>
                        {% if  attribute(datagrid, name).pager.haveToPaginate() %}

                            <div class="pagination pagination-centered">
                                <ul>

                                    {% if  attribute(datagrid, name).pager.page != 1 %}
                                        <li>
                                            <a href="{{ admin.generateUrl('init_ckeditor_browser', admin.modelmanager.paginationparameters( attribute(datagrid, name), 1)|merge(ckParameters)) }}"
                                               title="{{ 'link_first_pager'|trans({}, 'SonataAdminBundle') }}">&laquo;</a>
                                        </li>
                                    {% endif %}

                                    {% if  attribute(datagrid, name).pager.page !=  attribute(datagrid, name).pager.previouspage %}
                                        <li>
                                            <a href="{{ admin.generateUrl('init_ckeditor_browser', admin.modelmanager.paginationparameters( attribute(datagrid, name),  attribute(datagrid, name).pager.previouspage)|merge(ckParameters)) }}"
                                               title="{{ 'link_previous_pager'|trans({}, 'SonataAdminBundle') }}">&lsaquo;</a>
                                        </li>
                                    {% endif %}

                                    {# Set the number of pages to display in the pager #}
                                    {% for page in  attribute(datagrid, name).pager.getLinks() %}
                                        {% if page ==  attribute(datagrid, name).pager.page %}
                                            <li class="active"><a
                                                        href="{{ admin.generateUrl('init_ckeditor_browser', admin.modelmanager.paginationparameters( attribute(datagrid, name), page)|merge(ckParameters)) }}">{{ page }}</a>
                                            </li>
                                        {% else %}
                                            <li>
                                                <a href="{{ admin.generateUrl('init_ckeditor_browser', admin.modelmanager.paginationparameters( attribute(datagrid, name), page)|merge(ckParameters)) }}">{{ page }}</a>
                                            </li>
                                        {% endif %}
                                    {% endfor %}

                                    {% if  attribute(datagrid, name).pager.page !=  attribute(datagrid, name).pager.nextpage %}
                                        <li>
                                            <a href="{{ admin.generateUrl('init_ckeditor_browser', admin.modelmanager.paginationparameters( attribute(datagrid, name),  attribute(datagrid, name).pager.nextpage)|merge(ckParameters)) }}"
                                               title="{{ 'link_next_pager'|trans({}, 'SonataAdminBundle') }}">&rsaquo;</a>
                                        </li>
                                    {% endif %}

                                    {% if  attribute(datagrid, name).pager.page !=  attribute(datagrid, name).pager.lastpage %}
                                        <li>
                                            <a href="{{ admin.generateUrl('init_ckeditor_browser', admin.modelmanager.paginationparameters( attribute(datagrid, name),  attribute(datagrid, name).pager.lastpage)|merge(ckParameters)) }}"
                                               title="{{ 'link_last_pager'|trans({}, 'SonataAdminBundle') }}">&raquo;</a>
                                        </li>
                                    {% endif %}

                                </ul>
                            </div>

                        {% endif %}
                    {% else %}
                        <p class="notice">
                            {{ 'no_result'|trans({}, 'NetworkingInitCmsBundle') }}
                        </p>
                    {% endif %}
                </div>
            </div>
        </div>
    {% endif %}
{% endfor %}
{% endblock %}

{% block list_filters %}
    {% set name = 'default' %}
    {% if admin.datagrid.filters %}
        <form action="{{ admin.generateUrl('init_ckeditor_browser') }}" method="GET"
              class="sonata-filter-form {{ admin.isChild and 1 == admin.datagrid.filters|length ? 'hide' : '' }}form-horizontal filters menu-filter">

            <input type="hidden" name="context" value="{{ persistent_parameters.context }}"/>
            {% if persistent_parameters.provider is defined %}
                <input type="hidden" name="provider" value="{{ persistent_parameters.provider }}"/>
            {% endif %}
            <input type="hidden" name="active_tab" value="{{ name }}"/>

            {% set filter_main = '' %}
            {% set filter_hidden = '' %}
            {% for filter in admin.datagrid.filters %}
                {% if filter.options.hidden is not defined  or (filter.options.hidden == false) %}
                    {% set filter_main %}
                    {{ filter_main }}
                    <div class="control-group">
                        <label for="{{ form.children[filter.formName].children['value'].vars.id }}"
                               class="control-label filter">{{ admin.trans(filter.label) }}</label>

                        <div>
                            {{ form_widget(form.children[filter.formName].children['type'], {'attr':{'class': 'input-medium sonata-filter-option' }}
                            ) }}
                            {{ form_widget(form.children[filter.formName].children['value'], {'attr':{'placeholder': admin.trans(filter.label), 'class': 'input-medium'} }) }}
                        </div>
                    </div>
                    {% endset %}
                {% else %}
                    {% set filter_hidden %}
                    {{ filter_hidden }}
                    <div class="control-group">
                        <label class="control-label filter {{ filter.isActive ? 'active' : 'inactive' }}"> {{ admin.trans(filter.label) }}</label>

                        <div>
                            {{ form_widget(form.children[filter.formName].children['type'], {'attr':{'class': 'input-medium sonata-filter-option' }}
                            ) }}
                            {{ form_widget(form.children[filter.formName].children['value'], {'attr':{'class': 'input-medium' }}
                            ) }}
                        </div>
                    </div>
                    {% endset %}
                {% endif %}
            {% endfor %}

            {#<strong>{{ 'label_filters'|trans({}, admin.translationDomain) }}</strong>#}
            {% set label = admin.label|trans({}, admin.translationDomain) %}
            <div>
                <div class="pull-left ">
                    <fieldset class="filter_legend">
                        <p class="info-soft">{{ 'info.filter'|trans({'%admin_label%':label }, 'NetworkingInitCmsBundle') }}</p>

                        <div class="filter_container row">
                            <div class="span10">
                                {{ filter_main }}
                                <input type="hidden" name="filter[_page]" id="filter__page" value="1"/>
                                {% set foo = form.children['_page'].setRendered() %}
                                <div id="hidden_filters" class="collapse">
                                    {% for paramKey, paramValue in admin.persistentParameters %}
                                        <input type="hidden" name="{{ paramKey }}" value="{{ paramValue }}"/>
                                    {% endfor %}
                                    {% if filter_hidden != '' %}
                                        {# add div with hidden / show function #}
                                        {{ filter_hidden }}
                                    {% endif %}
                                    {% set foo = form.children['_page'].setRendered() %}
                                </div>
                                <div>
                                    <input type="submit" class="btn btn-small"
                                           value="{{ 'btn_filter'|trans({}, 'NetworkingInitCmsBundle') }}"/>
                                    <a href="{{ admin.generateUrl('init_ckeditor_browser', {filters: 'reset'}|merge(ckParameters)) }}"
                                       class="link-underlined">
                                        {{ 'link_reset_filter'|trans({'%admin_label%': admin.label}, 'NetworkingInitCmsBundle') }}</a>
                                    {{ form_rest(form) }}
                                    {% if filter_hidden %}
                                        <span data-toggle="collapse" data-target="#hidden_filters" id="filter_toggle"
                                              class="filter-close cursor-pointer">
                                                {{ 'link.show_more_filters'|trans({}, 'NetworkingInitCmsBundle') }}
                                            </span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% for paramKey, paramValue in admin.persistentParameters|merge(ckParameters) %}
                            <input type="hidden" name="{{ paramKey }}" value="{{ paramValue }}"/>
                        {% endfor %}
                    </fieldset>
                </div>
                <div class="clearfix">&nbsp;</div>
            </div>
        </form>
    {% endif %}
    <ul class="nav menu-tabs nav-tabs">
        {% for name, context in media_pool.contexts %}
            <li {% if (active_tab is null and loop.first) or active_tab == name %}class="active"{% endif %}>
                <a href="#media_{{ name }}" data-toggle="tab">{{ ('media_context.' ~ name)|trans({}) }}</a>
            </li>
        {% endfor %}
    </ul>
{% endblock %}
