{% autoescape false %}
<script type="text/javascript">

    function start_save_page_settings(link) {
        link.onclick = null;

        // add the jQuery event to the a element
        jQuery(link)
                .click(update_page_settings)
                .trigger('click')
        ;
        return false;
    }

    var update_page_settings = function (event) {
        event.preventDefault();
        event.stopPropagation();
        var form = jQuery(this).closest('form');
        var url = form.action
        jQuery(form).ajaxSubmit({
            url:form.action,
            type:"POST",
            dataType:'json',
            data:{ _xml_http_request:true },
            success:function (xhr) {
                if (xhr.pageStatus != "{{ 'status_published'|trans({}, admin.translationDomain) }}") {
                    jQuery('.page_status').addClass('color-draft');
                } else {
                    jQuery('.page_status').removeClass('color-draft');
                }
                var pageSettings = jQuery(xhr.pageSettings).filter('#pageSettings').html();
                var pageStatus = jQuery(xhr.pageSettings).filter('#pageStatusSettings').html();

                jQuery('.page_status').html(xhr.pageStatus);
                jQuery('.page_title h1').html(xhr.title);
                jQuery('#pageSettings').html(pageSettings);
                jQuery('#pageStatusSettings').html(pageStatus);
                $('#pageSettingFields').modal('hide');
                updateLayoutBlocks(form, {});
                createMessageBox(xhr.messageStatus, xhr.message);
            }
        });
    };

    function createMessageBox(status, message) {
        var messageHtml = '<div class="alert alert-' + status + '"><a class="close" data-dismiss="alert" href="#">Ã—</a>' + message + '</div>';

        jQuery('.notice-block').html(messageHtml).fadeIn();
    }


    (function ($) {

        $("#{{ admin.getUniqid }}_locale").live('change', function () {
            var locale = $(this).val();
            $.getJSON(
                    '{{ admin.generateUrl('parentPageList') }}',
                    {locale:locale},
                    function (data) {
                        var parentPages = $("#{{ admin.getUniqid }}_parent");
                        parentPages.empty();
                        parentPages.append($('<option></option>'));
                        $.each(data, function (k, v) {
                            if (v) {
                                parentPages.append($('<option></option>').val(k).html(v));
                            }
                        });
                    }
            )
        })

    })(jQuery);

</script>
{% endautoescape %}
